# プログレスバー改善実装計画

**実装日時**: 2025年6月30日 22:06  
**GitHub Issue**: #8  
**ブランチ**: feature/issue-8-improved-progress-bars  
**作業者**: Claude  

## 概要

GitHub Issue #8の要件に従い、現在の独自プログレスバー実装から`uiprogress`パッケージを使用したコンパートメント単位の並列プログレスバー表示に変更します。

## 要求分析

### 変更要件
1. **コンパートメント単位プログレスバー**: 並列処理されるコンパートメント毎に個別プログレスバー表示
2. **リソース数ベース進捗**: 操作数ではなく実際に発見されたリソース数での進捗計算
3. **uiprogressパッケージ導入**: 現在の独自実装から外部ライブラリへ移行
4. **デフォルト挙動変更**: プログレスバー表示をデフォルトに（現在は`--progress`で明示的有効化）

### 修正要件
1. **進捗基準変更**: リソース数ベース → リソースタイプ数ベース（25種類）
2. **progress.go完全削除**: uiprogressのみ使用、独自実装廃止

## アーキテクチャ設計

### 現在の実装
```
単一プログレスバー（独自実装 - progress.go）
[████████████████░░░░] 75% | 150.5 res/s | ETA: 00:02:30 | Comp: 3/5 | Res: 1245
```

### 新設計
```
コンパートメント別プログレスバー（uiprogress）
Production      [████████████████████] 25/25 | 1,245 resources found
Development     [████████░░░░░░░░░░░░] 12/25 | 456 resources found
Testing         [██████████████░░░░░░] 18/25 | 789 resources found
Staging         [███░░░░░░░░░░░░░░░░░░] 3/25  | 123 resources found
```

### 技術的設計原則

#### 1. 進捗計算ロジック
```go
// リソースタイプ数ベース進捗（事前確定可能）
totalResourceTypes := len(discoveryFuncs) // 25種類
bar := uiprogress.AddBar(totalResourceTypes)

// 各リソースタイプ完了時
bar.Incr() // 1/25, 2/25, ... 25/25
```

#### 2. 並列処理統合
```go
// discovery.go内直接統合
func discoverAllResourcesWithProgress(...) {
    if enableProgress {
        uiprogress.Start()
        defer uiprogress.Stop()
    }
    
    // 各コンパートメント用プログレスバー
    compartmentBars := make(map[string]*uiprogress.Bar)
    for _, comp := range filteredCompartments {
        if enableProgress {
            bar := uiprogress.AddBar(len(discoveryFuncs))
            // プログレスバー設定
            compartmentBars[comp.ID] = bar
        }
    }
    
    // 並列処理内でプログレス更新
    go func(compartmentID string) {
        for resourceType, discoveryFunc := range discoveryFuncs {
            // リソース発見処理
            resources, err := discoveryFunc(...)
            
            // プログレス更新
            if enableProgress {
                compartmentBars[compartmentID].Incr()
            }
        }
    }(comp.ID)
}
```

## 実装ステップ

### Phase 1: 削除・準備 (Step 1-4)
- [x] **Step 1**: GitHub Issue #8調査とブランチ作成
- [x] **Step 2**: uiprogressパッケージ仕様調査
- [x] **Step 3**: 現在の並列処理構造分析
- [ ] **Step 4**: progress.go完全削除計画策定

### Phase 2: uiprogress導入 (Step 5-7)
- [ ] **Step 5**: uiprogressパッケージ導入、go.mod更新
- [ ] **Step 6**: types.goからProgressTracker関連構造体削除
- [ ] **Step 7**: discovery.go内でuiprogress直接統合実装

### Phase 3: 統合・調整 (Step 8-10)
- [ ] **Step 8**: main.goのプログレス関連フラグ処理修正
- [ ] **Step 9**: デフォルト挙動変更（showProgress=true）
- [ ] **Step 10**: clients.goなど他ファイルのprogress参照削除

### Phase 4: 品質保証 (Step 11-12)
- [ ] **Step 11**: 全テスト修正（progress.go削除対応）
- [ ] **Step 12**: 統合テスト・ドキュメント更新

## ファイル変更計画

### 削除ファイル
```bash
progress.go          # 完全削除（355行）
progress_test.go     # テストも削除
```

### 主要変更ファイル

#### discovery.go
```go
// 変更前
func discoverAllResourcesWithProgress(ctx context.Context, clients *OCIClients, progressTracker *ProgressTracker, filters FilterConfig)

// 変更後  
func discoverAllResourcesWithProgress(ctx context.Context, clients *OCIClients, enableProgress bool, filters FilterConfig)
```

#### types.go
```go
// 削除対象
type ProgressTracker struct { ... }
type ProgressUpdate struct { ... }
```

#### main.go
```go
// 変更前
showProgress := false  // デフォルト無効

// 変更後
showProgress := true   // デフォルト有効
```

#### go.mod
```go
// 追加
require github.com/gosuri/uiprogress v0.4.0
```

## 技術的課題と解決策

### 課題1: 並列処理同期
- **解決策**: uiprogressのゴルーチン安全性を活用
- **実装**: `bar.Incr()`のアトミック操作で安全な並列更新

### 課題2: 動的リソース数表示
- **解決策**: `AppendFunc`で動的表示更新
- **実装**: `sync.Map`でリソース数を管理

### 課題3: 後方互換性
- **解決策**: 既存フラグ機能維持、デフォルト値のみ変更
- **実装**: `--no-progress`で無効化可能

## 期待される改善効果

### ユーザビリティ向上
1. **並列処理可視化**: 各コンパートメントの進捗が個別に確認可能
2. **直感的進捗表示**: リソースタイプ単位の明確な進捗
3. **デフォルト有効**: 設定不要で最初からプログレス表示

### 保守性向上
1. **コード簡素化**: 355行のprogress.go削除
2. **外部ライブラリ活用**: 実績のあるuiprogressで安定性向上
3. **統合実装**: discovery.go内の一箇所に集約

### パフォーマンス
1. **軽量化**: 独自実装のオーバーヘッド削除
2. **メモリ効率**: uiprogressの最適化された実装

## 品質保証計画

### テスト戦略
1. **既存テスト修正**: progress.go削除に伴う全テスト見直し
2. **統合テスト**: uiprogress表示の動作確認
3. **パフォーマンステスト**: 改善後の性能検証

### 検証項目
- [ ] 5並列コンパートメント処理での正常表示
- [ ] `--no-progress`での無効化動作
- [ ] 大規模環境（1000+リソース）での動作
- [ ] エラー時の適切なプログレス停止

## スケジュール

```
Week 1: Step 4-7   (progress.go削除 + uiprogress統合)
Week 2: Step 8-10  (統合調整 + デフォルト変更)
Week 3: Step 11-12 (テスト修正 + 検証)
```

## 完了判定基準

1. ✅ progress.go完全削除
2. ✅ uiprogressパッケージ統合
3. ✅ コンパートメント単位プログレスバー表示
4. ✅ リソースタイプ数ベース進捗計算
5. ✅ デフォルト挙動変更
6. ✅ 全テスト通過
7. ✅ 性能劣化なし

## 参考資料

- uiprogressパッケージ: https://github.com/gosuri/uiprogress
- 現在の並列処理実装: discovery.go:1172-1320
- プログレス関連テスト: progress_test.go, system_integration_test.go

---

この計画書に基づいて実装を進行し、各ステップ完了時に進捗を更新します。